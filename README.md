# STM32 三轮全向底盘串口通信协议

  - **版本**: V1.0
  - **日期**: 2025-09-04

## 1\. 概述

本文档定义了上位机（PC、工控机、树莓派等）与STM32三轮全向底盘主控之间进行串口通信的数据格式和指令集。该协议旨在实现对底盘三个轮子的精确速度控制，并能实时获取底盘的轮速状态。

协议采用人类可读的ASCII字符格式，并包含校验和以确保通信的可靠性。

## 2\. 物理层参数

| 参数 | 值 |
| :--- | :--- |
| **接口** | UART (通用异步收发器) |
| **波特率** | 115200 bps |
| **数据位** | 8 |
| **校验位** | 无 (None) |
| **停止位** | 1 |
| **流控** | 无 (None) |

## 3\. 数据帧结构

所有通信数据均封装在具有特定格式的数据帧中。

### 3.1. 帧格式

`起始符` `数据负载` `校验分隔符` `校验和` `结束符`

**示例**: `$S 0,500.0*44\r\n`

### 3.2. 字段定义

| 字段 | 符号 | ASCII码 | 长度 (字节) | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| **起始符** | `$` | `0x24` | 1 | 标志一帧数据的开始。 |
| **数据负载** | (可变) | (可变) | 可变 | 包含指令字符和相关参数，详情见指令集。 |
| **校验分隔符**| `*` | `0x2A` | 1 | 用于分隔数据负载和校验和。 |
| **校验和** | `CS` | `0-9`, `A-F` | 2 | 8位异或校验和，以2位大写十六进制字符表示。 |
| **结束符** | `CR LF`| `0x0D 0x0A` | 2 | 标志一帧数据的结束（回车+换行）。 |

## 4\. 校验和计算方法

为保证数据在传输过程中的完整性，所有帧都包含一个8位的异或校验和。

  - **计算范围**: 从起始符 `$` **之后**的第一个字符（即指令字符）开始，到校验分隔符 `*` **之前**的最后一个字符，对每一个字节的ASCII码进行**异或 (XOR)** 运算。
  - **格式**: 计算出的8位结果（一个字节）需转换为2位大写十六进制ASCII字符。

#### 伪代码示例：

```c
// 示例: 计算指令 "$S 0,500.0*44\r\n" 的校验和
// 传入 checksum_data 的内容是 "S 0,500.0"

uint8_t calculate_checksum(const char* checksum_data) {
    uint8_t checksum = 0;
    int len = strlen(checksum_data);
    for (int i = 0; i < len; i++) {
        checksum ^= checksum_data[i];
    }
    return checksum;
}
```

## 5\. 指令集

### 5.1. 上位机 -\> 底盘 (下行指令)

#### **指令 `S`: 设置单个轮子速度**

  - **功能**: 设定指定ID轮子的PID目标转速。
  - **格式**: `$S <id>,<speed>*CS\r\n`
  - **参数**:
    | 参数 | 类型 | 范围 | 描述 |
    | :--- | :--- | :--- | :--- |
    | `id` | `uint8` | `0` - `2` | 电机ID，0-based索引。 |
    | `speed`| `float` | (任意) | 目标转速 (RPM)，负数代表反转。 |
  - **示例**:
      - `$S 0,500.0*44\r\n`  (设置0号轮目标速度为 500 RPM)
      - `$S 1,-300.5*6B\r\n` (设置1号轮目标速度为 -300.5 RPM)

#### **指令 `A`: 设置所有轮子速度**

  - **功能**: 同时设定所有三个轮子的PID目标转速。
  - **格式**: `$A <spd0>,<spd1>,<spd2>*CS\r\n`
  - **参数**:
    | 参数 | 类型 | 描述 |
    | :--- | :--- | :--- |
    | `spd0` | `float`| 0号轮的目标转速 (RPM)。 |
    | `spd1` | `float`| 1号轮的目标转速 (RPM)。 |
    | `spd2` | `float`| 2号轮的目标转速 (RPM)。 |
  - **示例**:
      - `$A 100,200,-300*7C\r\n` (设置0,1,2号轮速度分别为100, 200, -300 RPM)
      - `$A 0,0,0*51\r\n` (让所有轮子停止)

#### **指令 `Q`: 查询当前轮速**

  - **功能**: 请求底盘上报一次当前所有轮子的实际速度。
  - **格式**: `$Q*CS\r\n`
  - **参数**: 无
  - **示例**: `$Q*51\r\n`

### 5.2. 底盘 -\> 上位机 (上报消息)

#### **消息 `R`: 上报轮速**

  - **功能**: 响应 `Q` 指令，或由底盘主动定时上报当前所有轮子的实际转速。
  - **格式**: `$R <spd0>,<spd1>,<spd2>*CS\r\n`
  - **参数**:
    | 参数 | 类型 | 描述 |
    | :--- | :--- | :--- |
    | `spd0` | `float`| 0号轮由编码器测得的实际转速 (RPM)。 |
    | `spd1` | `float`| 1号轮由编码器测得的实际转速 (RPM)。 |
    | `spd2` | `float`| 2号轮由编码器测得的实际转速 (RPM)。 |
  - **示例**: `$R 498.7,-299.1,0.2*C8\r\n`

## 6\. 通信示例

一个典型的“查询-应答”交互流程：

1.  **上位机发送查询指令:**

    ```
    $Q*51\r\n
    ```

2.  **STM32底盘回复速度报告:**

    ```
    $R 100.2,199.8,-298.5*24\r\n
    ```